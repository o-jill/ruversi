<html lang="ja">
<head>
<title>t-test ruversi</title>
<!-- Bootstrap -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.4/css/bootstrap.min.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">
<script src="https://cdn.jsdelivr.net/npm/jstat@latest/dist/jstat.min.js"></script>
<script type="text/javascript">
/**
 * @param av1 mean data in of group A
 * @param sd1 unbiased standard deviation data in of group A
 * @param N1  number of data in group A
 * @param av2 mean of data in group B
 * @param sd2 unbiased standard deviation of data in group B
 * @param N2  number of data in group B
 */
function ttest(av1, sd1, N1, av2, sd2, N2) {
    let sn1 = sd1 * sd1 / N1;  // variance1/n1
    let sn2 = sd2 * sd2 / N2;  // variance2/n2

    let t = (av1 - av2) / Math.sqrt(sn1 + sn2);

    let dof_welch = (sn1 + sn2) * (sn1 + sn2)
            / (sn1 * sn1 / (N1 - 1) + sn2 * sn2 / (N2 - 1));
    let p = jStat.studentt.pdf(t, dof_welch);
    // let dof_studentt = N1 + N2 - 2;
    // let p = jStat.studentt.pdf(t, dof_studentt);
    return [t, p];
}

const invalid_data = "<span style='color:red;font-size:3em;'>invalid data...</span>";

function calc1() {
    let txt1 = document.getElementById("res1").value.trim();
    if (txt1.length < 3) {
        document.getElementById("result").innerHTML = invalid_data;
        return;
    }

    let res1 = txt1.split('±');
    if (res1.length < 2) {
        document.getElementById("result").innerHTML = invalid_data;
        return;
    }
    let a1 = res1[0].trim() - 0;
    let sd1 = res1[1].trim() - 0;
    if (a1 == undefined || isNaN(a1)
        || sd1 == undefined || isNaN(sd1) || sd1 < 0) {
        document.getElementById("result").innerHTML = invalid_data;
        return;
    }

    let N1 = document.getElementById("N1").value - 0;
    if (N1 == undefined || isNaN(N1) || N1 <= 1) {
        document.getElementById("result").innerHTML = invalid_data;
        return;
    }

    let txt2 = document.getElementById("res2").value.trim();
    if (txt2.length < 3) {
        document.getElementById("result").innerHTML = invalid_data;
        return;
    }

    let res2 = txt2.split('±');
    if (res2.length < 2) {
        document.getElementById("result").innerHTML = invalid_data;
        return;
    }
    let a2 = res2[0].trim() - 0;
    let sd2 = res2[1].trim() - 0;
    if (a2 == undefined || isNaN(a2)
        || sd2 == undefined || isNaN(sd2) || sd2 < 0) {
        document.getElementById("result").innerHTML = invalid_data;
        return;
    }

    let N2 = document.getElementById("N2").value - 0;
    if (N2 == undefined || isNaN(N2) || N2 <= 1) {
        document.getElementById("result").innerHTML = invalid_data;
        return;
    }

    let [t, p] = ttest(a1, sd1, N1, a2, sd2, N2);

    let thr = document.getElementById("thr").value - 0;
    document.getElementById("result").innerHTML =
        (p < thr) ? "<span style='color:red;font-size:3em;'>different</span>"
                  : "<span style='color:green;font-size:3em;'>not different</span>";
    document.getElementById("result").innerHTML +=
                  " t:" + t + " p:" + p;
}
function calc2() {
    let a1 = document.getElementById("avg1").value - 0;
    let sd1 = document.getElementById("sd1").value - 0;
    let N1 = document.getElementById("N1").value - 0;
    if (a1 == undefined || isNaN(a1)
        || sd1 == undefined || isNaN(sd1) || sd1 < 0
        || N1 == undefined || isNaN(N1) || N1 <= 1) {
        document.getElementById("result").innerHTML = invalid_data;
        return;
    }

    let a2 = document.getElementById("avg2").value - 0;
    let sd2 = document.getElementById("sd2").value - 0;
    let N2 = document.getElementById("N2").value - 0;
    if (a2 == undefined || isNaN(a2)
        || sd2 == undefined || isNaN(sd2) || sd2 < 0
        || N2 == undefined || isNaN(N2) || N2 <= 1) {
        document.getElementById("result").innerHTML = invalid_data;
        return;
    }

    let [t, p] = ttest(a1, sd1, N1, a2, sd2, N2);

    let thr = document.getElementById("thr").value - 0;
    document.getElementById("result").innerHTML =
        (p < thr) ? "<span style='color:red;font-size:3em;'>different</span>"
                  : "<span style='color:green;font-size:3em;'>not different</span>";
    document.getElementById("result").innerHTML +=
                  " t:" + t + " p:" + p;
}

function readdataarray(txt) {
    let sep = " ";
    if (txt.includes(",")) {
        sep = ",";
    } else if (txt.includes("\t")) {
        sep = "\t";
    } else if (txt.includes("\n")) {
        sep = "\n";
    }
    let elements = txt.split(sep);
    // 末尾の空要素を削除
    while (elements.length > 0 && elements[elements.length - 1] === "") {
        elements.pop();
    }
    return elements.map((e) => e.trim() - 0);
}

function calcavgsd(arr) {
    let sum = 0;
    let sqsum = 0;
    let n = arr.length;
    let dof = n - 1;

    for (const e of arr) {
        sum += e;
    }
    let avg = sum / n;

    for (const e of arr) {
        sqsum += (e - avg) * (e - avg);
    }
    let variance_unbiased = sqsum / dof;

    return [avg, Math.sqrt(variance_unbiased)];
}

function calc3() {
    let d1 = readdataarray(document.getElementById("data1").value);
    let d2 = readdataarray(document.getElementById("data2").value);
    // console.log(d1); console.log(d2);
    let N1 = d1.length;
    let N2 = d2.length;
    if (N1 <= 1 || N2 <= 1) {
        document.getElementById("result3").innerHTML =
            "<span style='color:red;font-size:3em;'>invalid data...</span>";
        return;
    }

    let [a1, sd1] = calcavgsd(d1);
    let [a2, sd2] = calcavgsd(d2);

    let [t, p] = ttest(a1, sd1, N1, a2, sd2, N2);

    let thr = document.getElementById("thr3").value - 0;
    document.getElementById("result3").innerHTML =
        (p < thr) ? "<span style='color:red;font-size:3em;'>different</span>"
                  : "<span style='color:green;font-size:3em;'>not different</span>";
    document.getElementById("stats3").innerHTML =
        "d1:" + a1 + " ± " + Math.sqrt(sd1) + " N=" + d1.length
      + "<br>d2:" + a2 + " ± " + Math.sqrt(sd2) + " N=" + d2.length
      + "<br>t:" + t + " p:" + p;
}

function getMedian(arr) {
    let sorted = [...arr].sort((a, b) => a - b);
    let n = arr.length;
    let idx = Math.floor(n / 2);
    return sorted[idx];
}

function calc3U() {
    let d1 = readdataarray(document.getElementById("data1").value);
    let d2 = readdataarray(document.getElementById("data2").value);
    // console.log(d1); console.log(d2);
    let n1 = d1.length;
    let n2 = d2.length;
    if (n1 <= 1 || n2 <= 1) {
        document.getElementById("result3").innerHTML =
            "<span style='color:red;font-size:3em;'>invalid data...</span>";
        return;
    }

    let [a1, sd1] = calcavgsd(d1);
    let [a2, sd2] = calcavgsd(d2);
    let m1 = getMedian(d1);
    let m2 = getMedian(d2);
    let [z, p] = mannWhitneyU(d1, d2);

    let thr = document.getElementById("thr3").value - 0;
    document.getElementById("result3").innerHTML =
        (p < thr) ? "<span style='color:red;font-size:3em;'>different</span>"
                  : "<span style='color:green;font-size:3em;'>not different</span>";
    document.getElementById("stats3").innerHTML =
        "d1:" + a1 + " ± " + Math.sqrt(sd1) + " Median:" + m1 + " N=" + d1.length
      + "<br>d2:" + a2 + " ± " + Math.sqrt(sd2) + " Median:" + m2 + " N=" + d2.length
      + "<br>z:" + z + " p:" + p;
}

// Mann-Whitney のU検定
// 正規近似を使用
function mannWhitneyU(groupA, groupB) {
    // 全データのランクを計算
    const combined = groupA.concat(groupB);
    const ranks = jStat.rank(combined);
    const n1 = groupA.length;
    const n2 = groupB.length;

    // ランク和を計算
    const sum1 = ranks.slice(0, n1).reduce((a, b) => a + b, 0);
    const sum2 = ranks.slice(n1).reduce((a, b) => a + b, 0);

    // タイ補正用に重複した個数を計算
    const filtered = combined.filter(
        function(elem, index, self) {
            return self.indexOf(elem) === index;
        }
    );
    let tieComp = 0;  // タイ補正値
    if (filtered.length != combined.length) {
        for (f_item of filtered) {
            const same = combined.filter(item => item == f_item);
            let t = same.length;
            tieComp += t * t * t - t;
        }
    }

    const U1 = sum1 - (n1 * (n1 + 1)) / 2;
    const U2 = sum2 - (n2 * (n2 + 1)) / 2;
    const U = Math.min(U1, U2);

    const meanU = n1 * n2 / 2;

    // varianceU = n1·n2·(n1+n2+1)/12 - [n1·n2/(12n(n-1))] x Σ(t_k^3 - t_k)
    const n1n2 = (n1 * n2 * (n1 + n2 + 1)) / 12;
    const varU = n1n2 - tieComp / n1n2;

    const sdU = Math.sqrt(varU);

    // 連続性補正の適用
    const continuityCorrection = 0.5;
    const Z = (U - meanU + continuityCorrection) / sdU;

    // 両側検定のp値
    return [Z, 2 * (1 - jStat.normal.cdf(Math.abs(Z), 0, 1))];
}

</script>
<style type="text/css">
input {
 font-size: 2em;
 text-align: right;
}
</style>
</head>
<body>

<h1>unpaired t test or Mann-Whitney U test</h1>
S.D. should be unbiased standard deviation!
<h2>a:</h2>
<input id="res1" value="960.8 ± 18.43" size="10"> or <input id="avg1" value="960.8" size="6"> ±<input id="sd1" value="18.43" size="5"><br>
(N=<input id="N1" value="30" size="5">)<br>
<h2>b:</h2>
<input id="res2" value="968.57 ± 7.99" size="10"> or <input id="avg2" value="968.57" size="6"> ±<input id="sd2" value="7.99" size="5"><br>
(N=<input id="N2" value="30" size="5">)<br>
<label>threshold:<input id="thr" value="0.05" size="5"></label><br>
<h2>result:</h2>
<div><input type="button" onclick="calc1();" value="- - calculate - -"> or <input type="button" onclick="calc2();" value="- - calculate - -"></div>
<span id="result"></span>

<hr>

<textarea id="data1" rows="10" cols="20" placeholder="0,1,2,3,..."></textarea>
<textarea id="data2" rows="10" cols="20" placeholder="a separator can be one of TAB(\t), LF(\n), comma(,) or SPACE( )."></textarea><br>
<label>threshold:<input id="thr3" value="0.05" size="5"></label><br>
<input type="button" onclick="calc3();" value="- calculate t -">
<input type="button" onclick="calc3U();" value="- calculate U -">
<span id="result3"></span><br>
<div id="stats3">stats will be here.</div>
</body>
</html>
