name: Duel

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

env:
  CARGO_TERM_COLOR: always

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v3
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: false # runs 'bundle install' and caches installed gems automatically
    - name: cpu
      run: cat /proc/cpuinfo
    - name: Run duel
      continue-on-error: true # とにかくログを保存するとこまで行きたい
      id: duel
      run: |
        echo RUSTFLAGS="-Ctarget-cpu=native" >> $GITHUB_ENV
        cargo run --release -- --duel 6 --ev1 data/evaltable.txt --ev2 data/evaltable.txt.old | tee > kifu/log.txt
    - name: duel result
      continue-on-error: true # とにかくログを保存するとこまで行きたい
      id: duel-result
      run: |
        tail -n 5 kifu/log.txt
        cat tools/header.txt > kifu/summary.html
        cat kifu/log.txt >> kifu/summary.html
        cat tools/footer.txt >> kifu/summary.html
        ruby tools/summaryduel.rb < kifu/log.txt > duelsummary.html
    - name: Set current datetime as env variable
      env:
        TZ: 'Asia/Tokyo' # タイムゾーン指定
      run: echo "CURRENT_DATETIME=$(date +'%Y%m%d%H%M%S')" >> $GITHUB_ENV
    - name: Save artifacts
      uses: actions/upload-artifact@v3
      with:
        name: kifu${{ matrix.kifu }}_${{ env.CURRENT_DATETIME }}
        path: |
          kifu
    - name: check error duel
      if: ${{ steps.duel.outcome == 'failure' }}
      run: |
        echo ${{ steps.utest.outcome }} == 'failure'
        exit 1
